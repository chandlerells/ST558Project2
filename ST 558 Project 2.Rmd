---
title: 'ST 558: Project 2'
author: "Chandler Ellsworth"
date: "2023-10-02"
output:
  toc: true
  toc_depth: 2
  toc_float: true
  code_folding: show
  theme: readable
  df_print: paged
---

The document is a vignette about contacting the `CollegeFootballData.com` (CFBD) API using created functions to query, parse, and return well-structured data. CFBD is a sports statistics and analytics website with no direct affiliation to the NCAA, its member conferences, or its member teams. 

The functions will be used in this document to obtain data from the API as well as some basic exploratory data analysis. The functions can be used to gather the following types of data:  

* talent composite ranking for a particular season by team  
* coaching history based on first and last name  
* high level team stats for a particular season and team  
* high level game results for a particular season and team  
* ending record for a particular season and team  
* general information for college football venues

#Overal

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```


```{r}
library(httr2)
library(jsonlite)
library(tidyverse)
```


```{r}
token <- 'L8SLuL2Jzi8KI5g0iHQYaERuCZgEDvyxDpOvDTgSqrLWvU7/8Yd5XuAPCfZJjMCJ'

req <- request("https://api.collegefootballdata.com/venues") %>% 
  req_auth_bearer_token(token) %>% 
  req_headers("Accept" = "application/json")

mydata <- req_perform(req)

mydf <- fromJSON(rawToChar(mydata$body))

mytib <- as_tibble(mydf)

mytib %>%
  select(name, capacity, grass, city, state, elevation, year_constructed, dome)
```

```{r}
team_talent_composite_rankings <- function(year) {
  
  token <- 'L8SLuL2Jzi8KI5g0iHQYaERuCZgEDvyxDpOvDTgSqrLWvU7/8Yd5XuAPCfZJjMCJ'
  
  url <- paste0("https://api.collegefootballdata.com/talent?year=",year)
  
  req <- request(url) %>% 
    req_auth_bearer_token(token) %>% 
    req_headers("Accept" = "application/json")
  
  mydata <- req_perform(req)
  
  mydf <- fromJSON(rawToChar(mydata$body))
  
  mytib <- as_tibble(mydf)
  
  mytib$talent <- as.integer(mytib$talent)
  
  return(mytib)

}
```


```{r}
coaching_history <- function(first_name, last_name) {
  token <- 'L8SLuL2Jzi8KI5g0iHQYaERuCZgEDvyxDpOvDTgSqrLWvU7/8Yd5XuAPCfZJjMCJ'
  
  url <- paste0("https://api.collegefootballdata.com/coaches?firstName=",first_name,"&lastName=",last_name)
  
  req <- request(url) %>% 
    req_auth_bearer_token(token) %>% 
    req_headers("Accept" = "application/json")
  
  mydata <- req_perform(req)
  
  mydf <- fromJSON(rawToChar(mydata$body))$seasons
  
  mytib <- as_tibble(mydf[[1]])
  
  return(mytib)
}
```


```{r}
team_season_stats <- function(year, team) {
  token <- 'L8SLuL2Jzi8KI5g0iHQYaERuCZgEDvyxDpOvDTgSqrLWvU7/8Yd5XuAPCfZJjMCJ'
  
  first_name <- word(team, 1)
  last_name <- word(team, 2)
  A <- word(word(team, 1, sep = "&"),2)
  M <- word(team, 2, sep = "&")
  
  url <- ifelse(grepl("&", team), paste0("https://api.collegefootballdata.com/stats/season?year=",
                       year,"&team=",first_name,"%20",A,"%26",M),
                ifelse(grepl(" ", team),
                       paste0("https://api.collegefootballdata.com/stats/season?year=",year,"&team=",
                              first_name,"%20",last_name),
                       paste0("https://api.collegefootballdata.com/stats/season?year=",year,"&team=",team)))
  
  req <- request(url) %>% 
    req_auth_bearer_token(token) %>% 
    req_headers("Accept" = "application/json")
  
  mydata <- req_perform(req)
  
  mydf <- fromJSON(rawToChar(mydata$body))
  
  mytib <- as_tibble(mydf)
  
  return(mytib)
}
```


```{r}
game_results <- function(year, team) {
  token <- 'L8SLuL2Jzi8KI5g0iHQYaERuCZgEDvyxDpOvDTgSqrLWvU7/8Yd5XuAPCfZJjMCJ'
  
  first_name <- word(team, 1)
  last_name <- word(team, 2)
  A <- word(word(team, 1, sep = "&"),2)
  M <- word(team, 2, sep = "&")
  
  url <- ifelse(grepl("&", team), paste0("https://api.collegefootballdata.com/games?year=",
                       year,"&seasonType=regular&team=",first_name,"%20",A,"%26",M),
                ifelse(grepl(" ", team),
                       paste0("https://api.collegefootballdata.com/games?year=",
                              year,"&seasonType=regular&team=",first_name,"%20",last_name),
                       paste0("https://api.collegefootballdata.com/games?year=",
                              year,"&seasonType=regular&team=",team)))
  
  req <- request(url) %>% 
  req_auth_bearer_token(token) %>% 
  req_headers("Accept" = "application/json")

  mydata <- req_perform(req)

  mydf <- fromJSON(rawToChar(mydata$body))

  mytib <- as_tibble(mydf)

  mytib <- mytib %>%
    select(season, week, attendance, venue, home_team, home_points, away_team, away_points, excitement_index)
  
  return(mytib)
}
```


```{r}
team_records <- function(year, team) {
  token <- 'L8SLuL2Jzi8KI5g0iHQYaERuCZgEDvyxDpOvDTgSqrLWvU7/8Yd5XuAPCfZJjMCJ'
  
  first_name <- word(team, 1)
  last_name <- word(team, 2)
  A <- word(word(team, 1, sep = "&"),2)
  M <- word(team, 2, sep = "&")
  
  url <- ifelse(grepl("&", team), paste0("https://api.collegefootballdata.com/records?year=",
                                         year,"&team=",first_name,"%20",A,"%26",M),
                ifelse(grepl(" ", team),
                       paste0("https://api.collegefootballdata.com/records?year=",
                              year,"&team=",first_name,"%20",last_name),
                       paste0("https://api.collegefootballdata.com/records?year=",
                              year,"&team=",team)))
  
  req <- request(url) %>% 
    req_auth_bearer_token(token) %>% 
    req_headers("Accept" = "application/json")

  mydata <- req_perform(req)

  mydf <- fromJSON(rawToChar(mydata$body))$total

  mytib <- as_tibble(mydf)
  
  return(mytib)
}
```

```{r}
venue_info <- function(venue_name = NULL) {
  token <- 'L8SLuL2Jzi8KI5g0iHQYaERuCZgEDvyxDpOvDTgSqrLWvU7/8Yd5XuAPCfZJjMCJ'

  req <- request("https://api.collegefootballdata.com/venues") %>% 
    req_auth_bearer_token(token) %>% 
    req_headers("Accept" = "application/json")

  mydata <- req_perform(req)

  mydf <- fromJSON(rawToChar(mydata$body))

  mytib <- as_tibble(mydf)

  mytib <- mytib %>%
    select(name, capacity, grass, city, state, elevation, year_constructed, dome)
  
  ifelse(!is.null(venue_name),
         mytib <- mytib %>%
           filter(name == venue_name),
         NA)
  
  return(mytib)
}
```


```{r}
years <- c(2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023)

listy <- list()

for (year in years) {
  
  mytib <- team_talent_composite_rankings(year)
  
  listy <- append(listy, list(mytib), 0)
}

talent <- bind_rows(listy)

average <- talent %>%
  group_by(school) %>%
  summarise(average_talent = round(mean(talent),2)) %>%
  arrange(desc(average_talent))

ggplot(average[1:10,], aes(x = reorder(school, -average_talent),
                           y = average_talent,
                           fill = school)) +
  geom_bar(stat = "identity") + 
  labs(x = "School",
       y = "Average Talent",
       title = "Average School Talent Over Past 10 Years") +
  scale_fill_discrete(name = "School") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) +
  geom_text(aes(label = average_talent,), 
            size = 3, 
            position = position_stack(vjust = 0.8))
```

```{r}
listy2 <- average[1:10,]$school

talent_filter <- talent %>%
  filter(school %in% listy2)

ggplot(talent_filter, aes(x = school, y = year, fill = talent)) +
  geom_tile() +
  scale_fill_gradient(low="white", high="blue") +
  labs(x = "School",
       y = "Year",
       title = "School Talent Over Past 10 Years",) +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_x_discrete(guide = guide_axis(n.dodge=2))
```


```{r}
combo <- expand.grid(years, listy2)

list_tib <- apply(combo, MARGIN = 1, 
                  FUN = function(x) {
                    tib <- game_results(x[1],x[2])
                    tib$team <- x[2]
                    if_else(tib$home_team == x[2], 
                            mutate(tib, point_diff = (home_points - away_points)), 
                                   mutate(tib, point_diff = (away_points - home_points)))})

bind_tib <- bind_rows(list_tib) %>%
  filter(!is.na(point_diff))

bind_tib_avg <- bind_tib %>%
  group_by(team) %>%
  summarise(avg_point_margin = mean(point_diff)) %>%
  arrange(desc(avg_point_margin))

ggplot(bind_tib_avg, aes(x = reorder(team, -avg_point_margin), 
                         y = avg_point_margin,
                         fill = team)) +
  geom_bar(stat = "identity") + 
  labs(x = "School",
       y = "Average Margin of Victory",
       title = "Average Margin of Victory Over Past 10 Years") +
  scale_fill_discrete(name = "School") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) +
  geom_text(aes(label = round(avg_point_margin, 2)), 
            size = 3, 
            position = position_stack(vjust = 0.8))

```

```{r}
2+2
```


